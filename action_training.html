<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>动作模式训练 - 髋关节铰链</title>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose/pose.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>

    <style>
        /* 保留原有的 UI 风格并微调 */
        body { margin: 0; font-family: "Microsoft YaHei", sans-serif; background: linear-gradient(135deg,#e6f9f7,#e8f4ff); color: #034b4a; }
        .header { height: 80px; display: flex; align-items: center; justify-content: center; }
        .title { font-size: 36px; font-weight: bold; color: #007b7a; letter-spacing: 3px; }
        .container { width: 92%; margin: 20px auto; display: grid; grid-template-columns: 1fr 2fr; gap: 20px; }
        .card { background: #ffffff; border-radius: 15px; padding: 18px; box-shadow: 0 6px 15px rgba(0,150,140,0.2); position: relative; }
        .card h3 { margin-top: 0; color: #007b7a; }
        .action-list button { width: 100%; margin-bottom: 14px; padding: 14px; font-size: 16px; font-weight: bold; border-radius: 22px; border: none; background: linear-gradient(90deg,#00b3a4,#00c6ff); color: white; cursor: pointer; }
        .video-container { position: relative; width: 100%; height: 500px; background: #000; border-radius: 12px; overflow: hidden; }
        video { width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1); }
        #overlayCanvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; transform: scaleX(-1); pointer-events: none; }
        .train-info { position: absolute; top: 18px; right: 18px; text-align: right; font-size: 16px; font-weight: bold; color: #007b7a; z-index: 5; background: rgba(255,255,255,0.7); padding: 5px 10px; border-radius: 10px; }
        #statusText { margin-top: 12px; font-size: 18px; font-weight: bold; text-align: center; }
        .error { color: #d9534f; }
        .correct { color: #00a36c; }
        .finish-btn-container { text-align: center; margin: 20px 0 40px 0; }
        #finishTrainingBtn { padding: 14px 40px; font-size: 18px; font-weight: bold; border-radius: 30px; border: none; background: linear-gradient(90deg,#00b3a4,#00c6ff); color: white; cursor: pointer; }
    </style>
</head>

<body>
<div class="header"><div class="title">动作模式训练</div></div>

<div class="container">
    <div class="card action-list">
        <h3>居家训练动作</h3>
        <button>猫牛式</button>
        <button onclick="startHipHinge()">髋关节铰链训练</button>
        <button>麦肯基伸展</button>
        <button>侧桥</button>
        <button>死虫式</button>
    </div>

    <div class="card monitor-card">
        <h3>训练监测区</h3>
        <div id="trainInfo" class="train-info">次数：0/15</div>
        <div class="video-container">
            <video id="video"></video>
            <canvas id="overlayCanvas"></canvas>
        </div>
        <div id="statusText">请点击左侧按钮开始</div>
    </div>
</div>

<div class="finish-btn-container">
    <button id="finishTrainingBtn" onclick="location.href='training-result.html'">完成全部训练</button>
</div>

<script>
let currentRep = 0;
let demoStage = 0;
const totalRep = 15;

const videoElement = document.getElementById("video");
const canvasElement = document.getElementById("overlayCanvas");
const canvasCtx = canvasElement.getContext("2d");
const statusText = document.getElementById("statusText");
const trainInfo = document.getElementById("trainInfo");

function speak(text) {
    const u = new SpeechSynthesisUtterance(text);
    u.lang = "zh-CN";
    speechSynthesis.cancel();
    speechSynthesis.speak(u);
}

const pose = new Pose({
    locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/pose/${file}`
});

pose.setOptions({ modelComplexity: 1, smoothLandmarks: true, minDetectionConfidence: 0.6, minTrackingConfidence: 0.6 });
pose.onResults(onPoseResults);

const camera = new Camera(videoElement, {
    onFrame: async () => { await pose.send({ image: videoElement }); },
    width: 640, height: 480
});

// 核心绘制逻辑
function onPoseResults(results) {
    canvasElement.width = videoElement.clientWidth;
    canvasElement.height = videoElement.clientHeight;
    canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);

    if (!results.poseLandmarks) return;

    const lm = results.poseLandmarks;
    const w = canvasElement.width;
    const h = canvasElement.height;

    // 坐标转换辅助
    const pt = (idx) => ({ x: lm[idx].x * w, y: lm[idx].y * h });

    // 关键点定义
    const nose = pt(0);
    const lShoulder = pt(11), rShoulder = pt(12);
    const lHip = pt(23), rHip = pt(24);
    const lKnee = pt(25), rKnee = pt(26);
    const lAnkle = pt(27), rAnkle = pt(28);
    const midShoulder = { x: (lShoulder.x + rShoulder.x)/2, y: (lShoulder.y + rShoulder.y)/2 };
    const midHip = { x: (lHip.x + rHip.x)/2, y: (lHip.y + rHip.y)/2 };

    // 计算角度 (肩-髋-膝) 用于判定
    const hipAngle = calculateAngle(lShoulder, lHip, lKnee);
    let isCorrect = window.forceDemoState === "correct" || (window.forceDemoState !== "error" && hipAngle < 150);

    // 颜色配置
    const mainColor = isCorrect ? "#00a36c" : "#d9534f";
    canvasCtx.strokeStyle = mainColor;
    canvasCtx.fillStyle = mainColor;
    canvasCtx.lineWidth = 4;

    // 1. 绘制全骨架连线
    const connections = [
        [11, 12], [11, 23], [12, 24], [23, 24], // 躯干
        [11, 13], [13, 15], [12, 14], [14, 16], // 手臂
        [23, 25], [25, 27], [24, 26], [26, 28]  // 腿部
    ];
    
    connections.forEach(([i, j]) => {
        canvasCtx.beginPath();
        canvasCtx.moveTo(lm[i].x * w, lm[i].y * h);
        canvasCtx.lineTo(lm[j].x * w, lm[j].y * h);
        canvasCtx.stroke();
    });

    // 2. 绘制头部单点
    canvasCtx.beginPath();
    canvasCtx.arc(nose.x, nose.y, 8, 0, Math.PI * 2);
    canvasCtx.fill();

    // 3. 绘制关键关节圆点 (简化展示)
    [11, 12, 23, 24, 25, 26, 27, 28].forEach(i => {
        canvasCtx.beginPath();
        canvasCtx.arc(lm[i].x * w, lm[i].y * h, 5, 0, Math.PI * 2);
        canvasCtx.fill();
    });

    // 4. 指导运动方向的箭头 (仅在动作不达标或错误时出现)
    if (!isCorrect || window.forceDemoState === "error") {
        // 胸部箭头：提示向下/向前压 (铰链下行阶段)
        drawArrow(midShoulder.x, midShoulder.y, 0, 60, "#ffce00"); 
        // 髋部箭头：提示向后推
        drawArrow(midHip.x, midHip.y, 50, 0, "#ffce00"); 

        canvasCtx.font = "bold 16px Arial";
        canvasCtx.fillText("胸部下压", midShoulder.x + 10, midShoulder.y + 40);
        canvasCtx.fillText("髋部后推", midHip.x + 40, midHip.y);
    }

    // 状态更新
    statusText.innerText = isCorrect ? "动作标准：感受臀部拉伸" : "注意：请尝试将髋部向后推，背部挺直";
    statusText.className = isCorrect ? "correct" : "error";
}

// 辅助：绘制箭头
function drawArrow(x, y, dx, dy, color) {
    const headlen = 15;
    const angle = Math.atan2(dy, dx);
    canvasCtx.save();
    canvasCtx.strokeStyle = color;
    canvasCtx.fillStyle = color;
    canvasCtx.lineWidth = 6;
    canvasCtx.beginPath();
    canvasCtx.moveTo(x, y);
    canvasCtx.lineTo(x + dx, y + dy);
    canvasCtx.stroke();
    canvasCtx.beginPath();
    canvasCtx.moveTo(x + dx, y + dy);
    canvasCtx.lineTo(x + dx - headlen * Math.cos(angle - Math.PI / 6), y + dy - headlen * Math.sin(angle - Math.PI / 6));
    canvasCtx.lineTo(x + dx - headlen * Math.cos(angle + Math.PI / 6), y + dy - headlen * Math.sin(angle + Math.PI / 6));
    canvasCtx.closePath();
    canvasCtx.fill();
    canvasCtx.restore();
}

// 辅助：计算角度
function calculateAngle(a, b, c) {
    const radians = Math.atan2(c.y - b.y, c.x - b.x) - Math.atan2(a.y - b.y, a.x - b.x);
    let angle = Math.abs(radians * 180.0 / Math.PI);
    if (angle > 180.0) angle = 360 - angle;
    return angle;
}

// 按钮控制逻辑
async function startHipHinge() {
    demoStage++;
    if (demoStage === 1) {
        camera.start();
        statusText.innerText = "准备中...请侧对摄像头";
        return;
    }
    if (demoStage === 2) {
        window.forceDemoState = "error";
        speak("注意：不要只弯腰，尝试把屁股往后坐");
    } else {
        window.forceDemoState = "correct";
        currentRep = Math.min(currentRep + 1, totalRep);
        speak(currentRep === totalRep ? "训练完成" : "动作正确");
    }
    trainInfo.innerText = `次数：${currentRep} / ${totalRep}`;
}
</script>
</body>
</html>