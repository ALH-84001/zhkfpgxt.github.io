<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<title>动作模式训练</title>

<!-- MediaPipe 离线 JS -->
<script src="./pose.js"></script>
<script src="./drawing_utils.js"></script>
<script src="./camera_utils.js"></script>

<style>
/* ===== 全局风格 ===== */
body {
    margin: 0;
    font-family: "Microsoft YaHei", Arial, sans-serif;
    background: linear-gradient(135deg,#e6f9f7,#e8f4ff);
    color: #034b4a;
}

/* ===== 顶部 ===== */
.header {
    height: 80px;
    display: flex;
    align-items: center;
    justify-content: center;
}
.title {
    font-size: 36px;
    font-weight: bold;
    color: #007b7a;
    letter-spacing: 3px;
}

/* ===== 主体布局 ===== */
.container {
    width: 92%;
    margin: 20px auto;
    display: grid;
    grid-template-columns: 1fr 2fr;
    gap: 20px;
}

/* ===== 卡片 ===== */
.card {
    background: #ffffff;
    border-radius: 15px;
    padding: 18px;
    box-shadow: 0 6px 15px rgba(0,150,140,0.2);
    position: relative;
}
.card h3 {
    margin-top: 0;
    color: #007b7a;
}

/* ===== 左侧动作按钮 ===== */
.action-list button {
    width: 100%;
    margin-bottom: 14px;
    padding: 14px;
    font-size: 16px;
    font-weight: bold;
    border-radius: 22px;
    border: none;
    background: linear-gradient(90deg,#00b3a4,#00c6ff);
    color: white;
    cursor: pointer;
}
.action-list button:hover {
    opacity: 0.9;
}

/* ===== 视频监测区 ===== */
.video-container {
    position: relative;
    width: 100%;
    height: 420px;
    background: #000;
    border-radius: 12px;
    overflow: hidden;
}
video {
    width: 100%;
    height: 100%;
    object-fit: cover;
}
#overlayCanvas {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    pointer-events: none;
}

/* ===== 右上角训练次数 ===== */
.train-info {
    position: absolute;
    top: 18px;
    right: 18px;
    text-align: right;
    font-size: 16px;
    font-weight: bold;
    color: #007b7a;
}

/* ===== 状态提示 ===== */
#statusText {
    margin-top: 12px;
    font-size: 18px;
    font-weight: bold;
}
.error { color: #d9534f; }
.correct { color: #00a36c; }

/* ===== 完成训练按钮 ===== */
.finish-btn-container {
    text-align: center;
    margin: 20px 0 40px 0;
}
#finishTrainingBtn {
    padding: 14px 28px;
    font-size: 18px;
    font-weight: bold;
    border-radius: 22px;
    border: none;
    background: linear-gradient(90deg,#00b3a4,#00c6ff);
    color: white;
    cursor: pointer;
    transition: all 0.3s ease;
}
#finishTrainingBtn:hover {
    opacity: 0.9;
}

/* ===== 移动端自适应 ===== */
@media (max-width: 768px) {
    /* 容器单列排列 */
    .container {
        display: flex;
        flex-direction: column;
        gap: 16px;
        width: 95%;
        margin: 10px auto;
    }

    /* 动作按钮网格两列 */
    .card.action-list {
        order: 0;
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 10px;
    }
    .action-list button {
        width: 100%;
        font-size: 14px;
        padding: 12px;
    }

    /* 训练监测区在动作按钮下方 */
    .card.monitor-card {
        order: 1;
        width: 100%;
        padding: 16px;
    }

    /* 视频高度适应小屏幕 */
    .video-container {
        height: 280px;
    }

    /* 顶部标题缩小 */
    .title {
        font-size: 28px;
        letter-spacing: 1.5px;
    }

    /* 右上角训练次数调整 */
    .train-info {
        top: 12px;
        right: 12px;
        font-size: 14px;
    }

    /* 状态提示字体稍小 */
    #statusText {
        font-size: 16px;
    }

    /* 完成按钮在最下方 */
    .finish-btn-container {
        order: 2;
        display: flex;
        justify-content: center;
    }
    .finish-btn-container button {
        width: 90%;
        max-width: 360px;
        font-size: 16px;
        padding: 14px 20px;
    }
}
</style>
</head>

<body>
<div class="header">
    <div class="title">动作模式训练</div>
</div>

<div class="container">
    <!-- 左侧动作按钮 -->
    <div class="card action-list">
        <h3>居家训练动作</h3>
        <button>猫牛式</button>
        <button onclick="startHipHinge()">髋关节铰链训练</button>
        <button>麦肯基伸展</button>
        <button>侧桥</button>
        <button>死虫式</button>
    </div>

    <!-- 右侧训练监测区 -->
    <div class="card monitor-card">
        <h3>训练监测区</h3>
        <div id="trainInfo" class="train-info"></div>
        <div class="video-container">
            <video id="video" autoplay muted playsinline></video>
            <canvas id="overlayCanvas"></canvas>
        </div>
        <div id="statusText">请选择左侧训练动作</div>
    </div>
</div>

<!-- 完成全部训练按钮 -->
<div class="finish-btn-container">
    <button id="finishTrainingBtn">完成全部训练</button>
</div>

</body>
</html>

<script>

// 完成全部训练按钮点击跳转
document.getElementById("finishTrainingBtn").addEventListener("click", function() {
    window.location.href = "training-result.html";
});


/* ================= 基础变量 ================= */
let clickCount = 0;
let currentRep = 0;

let demoStage = 0;   // 点击“髋关节铰链训练”次数

const totalRep = 15;
const currentSet = 1;
const totalSet = 4;

const videoElement = document.getElementById("video");
const canvasElement = document.getElementById("overlayCanvas");
const canvasCtx = canvasElement.getContext("2d");

const statusText = document.getElementById("statusText");
const trainInfo = document.getElementById("trainInfo");

/* ================= 语音提示 ================= */
function speak(text) {
    const u = new SpeechSynthesisUtterance(text);
    u.lang = "zh-CN";
    speechSynthesis.cancel();
    speechSynthesis.speak(u);
}

/* ================= MediaPipe Pose 初始化 ================= */
const pose = new Pose({
    locateFile: (file) =>
        `https://cdn.jsdelivr.net/npm/@mediapipe/pose/${file}`
});

pose.setOptions({
    modelComplexity: 1,
    smoothLandmarks: true,
    enableSegmentation: false,
    minDetectionConfidence: 0.5,
    minTrackingConfidence: 0.5
});

pose.onResults(onPoseResults);

/* ================= 摄像头 ================= */
const camera = new Camera(videoElement, {
    onFrame: async () => {
        await pose.send({ image: videoElement });
    },
    width: 640,
    height: 480
});

/* ================= Pose 结果回调 ================= */
function onPoseResults(results) {
    canvasElement.width = canvasElement.offsetWidth;
    canvasElement.height = canvasElement.offsetHeight;

    canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);

    if (!results.poseLandmarks) return;

    const lm = results.poseLandmarks;

    // ===== 取左侧关键点（侧面示范）=====
    const head = lm[0];
    const shoulder = lm[11];
    const hip = lm[23];
    const knee = lm[25];
    const ankle = lm[27];

    // ===== 计算肩-髋-膝夹角 =====
    function angle(a, b, c) {
        const ab = { x: a.x - b.x, y: a.y - b.y };
        const cb = { x: c.x - b.x, y: c.y - b.y };
        const dot = ab.x * cb.x + ab.y * cb.y;
        const magAB = Math.hypot(ab.x, ab.y);
        const magCB = Math.hypot(cb.x, cb.y);
        return Math.acos(dot / (magAB * magCB)) * (180 / Math.PI);
    }

    const hipAngle = angle(shoulder, hip, knee);
    let isCorrect;

    // ===== 教学演示优先 =====
    if (window.forceDemoState === "error") {
        isCorrect = false;
    } else if (window.forceDemoState === "correct") {
        isCorrect = true;
    } else {
    // 正常 AI 判定
        isCorrect = hipAngle >= 165;
    }

    // ===== 样式控制 =====
    if (isCorrect) {
        canvasCtx.strokeStyle = "#00a65a"; // 绿色
        canvasCtx.setLineDash([]);         // 实线
    } else {
        canvasCtx.strokeStyle = "#d60000"; // 红色
        canvasCtx.setLineDash([8, 6]);     // 虚线
    }

    canvasCtx.lineWidth = 4;              // 线条加粗
    canvasCtx.fillStyle = canvasCtx.strokeStyle;

    function px(p) {
        return {
            x: p.x * canvasElement.width,
            y: p.y * canvasElement.height
        };
    }

    function drawLine(a, b) {
        canvasCtx.beginPath();
        canvasCtx.moveTo(a.x, a.y);
        canvasCtx.lineTo(b.x, b.y);
        canvasCtx.stroke();
    }

    function drawPoint(p) {
        canvasCtx.beginPath();
        canvasCtx.arc(p.x, p.y, 6, 0, Math.PI * 2);
        canvasCtx.fill();
    }

    const P = {
        head: px(head),
        shoulder: px(shoulder),
        hip: px(hip),
        knee: px(knee),
        ankle: px(ankle)
    };

    // ===== 画骨架 =====
    drawLine(P.head, P.shoulder);
    drawLine(P.shoulder, P.hip);
    drawLine(P.hip, P.knee);
    drawLine(P.knee, P.ankle);

    Object.values(P).forEach(drawPoint);

    // ===== 错误时画运动方向箭头 =====
    if (!isCorrect) {
        drawArrow(P.shoulder.x + 60, P.shoulder.y, 100, 0);  // 肩 → 右
        drawArrow(P.hip.x - 40, P.hip.y, -100, 0);           // 髋 ← 左
    }

    // ===== 状态文字 =====
    statusText.innerText = isCorrect
        ? "注意：动作正确"
        : "注意：动作错误，请保持腰部挺直";
    statusText.className = isCorrect ? "correct" : "error";
}

/* ========= 新增箭头绘制函数 ==================*/
function drawArrow(x, y, dx, dy) {
    canvasCtx.save();
    canvasCtx.strokeStyle = "#d60000";
    canvasCtx.fillStyle = "#d60000";
    canvasCtx.lineWidth = 4;
    canvasCtx.setLineDash([]);

    canvasCtx.beginPath();
    canvasCtx.moveTo(x, y);
    canvasCtx.lineTo(x + dx, y + dy);
    canvasCtx.stroke();

    // 箭头
    const angle = Math.atan2(dy, dx);
    const headLen = 10;

    canvasCtx.beginPath();
    canvasCtx.moveTo(x + dx, y + dy);
    canvasCtx.lineTo(
        x + dx - headLen * Math.cos(angle - Math.PI / 6),
        y + dy - headLen * Math.sin(angle - Math.PI / 6)
    );
    canvasCtx.lineTo(
        x + dx - headLen * Math.cos(angle + Math.PI / 6),
        y + dy - headLen * Math.sin(angle + Math.PI / 6)
    );
    canvasCtx.closePath();
    canvasCtx.fill();
    canvasCtx.restore();
}

/* ================= 启动训练 ================= */
async function startHipHinge() {
    demoStage++;

    // 第一次点击：启动摄像头
    if (demoStage === 1) {
        currentRep = 0;
        // 启动摄像头（只启动一次）
        if (!camera.isRunning) {
            camera.start();
            camera.isRunning = true;
        }
        return;
    }


    // 第2次点击：固定显示错误示范
    if (demoStage === 2) {
        currentRep = 0;

        trainInfo.innerHTML = `第 ${currentRep} / ${totalRep} 次<br>第 ${currentSet} / ${totalSet} 组`;
        statusText.innerText = "注意：动作错误，请保持腰部挺直";
        statusText.className = "error";

        // 启动摄像头（只启动一次）
        if (!camera.isRunning) {
            camera.start();
            camera.isRunning = true;
        }

        // 标记：强制错误显示
        window.forceDemoState = "error";

        speak("动作错误，请保持腰部挺直");
        return;
    }

    // 第3次点击：固定显示正确示范
    if (demoStage >= 3 && demoStage <= 6) {
        currentRep++;

        trainInfo.innerHTML = `第 ${currentRep} / ${totalRep} 次<br>第 ${currentSet} / ${totalSet} 组`;
        statusText.innerText = "注意：动作正确";
        statusText.className = "correct";

        // 标记：强制正确显示
        window.forceDemoState = "correct";
        speak("动作正确");

        return;
    }

    // 第6次及以后：进入正常训练流程
    window.forceDemoState = null;

    if (currentRep < totalRep) {
        currentRep++;
        trainInfo.innerHTML = `第 ${currentRep} / ${totalRep} 次<br>第 ${currentSet} / ${totalSet} 组`;
        statusText.innerText = "注意：动作正确";
        statusText.className = "correct";
    }

    if (currentRep === totalRep) {
        speak("本组训练完成，请休息");
    }
}
</script>

</body>

</html>

